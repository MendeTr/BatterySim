<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batteri ROI Kalkylator - Sverige</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .metric {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
        }
        .metric-label {
            opacity: 0.9;
            font-size: 0.875rem;
        }
        .insight-success {
            background: #10b981;
            color: white;
        }
        .insight-warning {
            background: #f59e0b;
            color: white;
        }
        .insight-info {
            background: #3b82f6;
            color: white;
        }
        .insight-tip {
            background: #8b5cf6;
            color: white;
        }
        .button-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .button-primary:hover {
            transform: translateY(-2px);
        }
        .button-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        
        const API_BASE = 'http://localhost:5001/api';

        function App() {
            const [step, setStep] = useState(1);
            const [file, setFile] = useState(null);
            const [uploadedFile, setUploadedFile] = useState(null);
            const [loading, setLoading] = useState(false);
            const [progress, setProgress] = useState({ percent: 0, message: '' });
            const [batteryPresets, setBatteryPresets] = useState([]);
            const [networkOperators, setNetworkOperators] = useState([]);
            const [results, setResults] = useState(null);
            
            const [config, setConfig] = useState({
                battery_capacity_kwh: 10,
                battery_power_kw: 5,
                battery_cost_sek: 80000,
                battery_efficiency: 0.95,
                battery_lifetime_years: 15,
                grid_fee_sek_kwh: 0.45,
                energy_tax_sek_kwh: 0.40,
                effect_tariff_sek_kw_month: 50,
                effect_tariff_method: 'top3_average',
                vat_rate: 0.25,
                solar_capacity_kwp: 0,
                enable_arbitrage: true,
                // use_gpt_arbitrage removed - Boss Agent with 24h LP optimization is now default
                stodtjanster_revenue_sek_year: 0
            });

            useEffect(() => {
                // Load presets and network operators
                fetch(`${API_BASE}/battery/presets`)
                    .then(r => r.json())
                    .then(data => setBatteryPresets(data.presets))
                    .catch(e => console.error('Failed to load presets:', e));
                
                fetch(`${API_BASE}/network-operators`)
                    .then(r => r.json())
                    .then(data => setNetworkOperators(data.operators))
                    .catch(e => console.error('Failed to load operators:', e));
            }, []);

            const handleFileChange = (e) => {
                setFile(e.target.files[0]);
            };

            const handleUpload = async () => {
                if (!file) {
                    alert('Vänligen välj en fil först');
                    return;
                }

                setLoading(true);
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch(`${API_BASE}/upload`, {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        setUploadedFile(data);
                        setStep(2);
                    } else {
                        alert('Fel vid uppladdning: ' + data.error);
                    }
                } catch (error) {
                    alert('Fel vid uppladdning: ' + error.message);
                } finally {
                    setLoading(false);
                }
            };

            const handleSimulate = async () => {
                setLoading(true);
                setProgress({ percent: 0, message: 'Starting...' });

                // Start listening to progress updates via SSE
                const eventSource = new EventSource(`${API_BASE}/progress`);
                eventSource.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    setProgress(data);
                    if (data.percent >= 100) {
                        eventSource.close();
                    }
                };

                try {
                    const response = await fetch(`${API_BASE}/simulate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            filename: uploadedFile.filename,
                            ...config
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        setResults(data.report);
                        setStep(3);
                    } else {
                        alert('Simulering misslyckades: ' + data.error);
                    }
                } catch (error) {
                    alert('Simulering misslyckades: ' + error.message);
                } finally {
                    setLoading(false);
                    eventSource.close();
                }
            };

            const estimateStodtjanster = async (serviceType = 'fcr_n') => {
                try {
                    const response = await fetch(`${API_BASE}/stodtjanster/estimate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            battery_power_kw: config.battery_power_kw,
                            battery_capacity_kwh: config.battery_capacity_kwh,
                            service_type: serviceType
                        })
                    });

                    const data = await response.json();
                    
                    if (data.eligible) {
                        setConfig({
                            ...config,
                            stodtjanster_revenue_sek_year: data.estimated_revenue_sek_year
                        });
                        alert(`Uppskattad intäkt från ${serviceType.toUpperCase()}: ${data.estimated_revenue_sek_year.toFixed(0)} SEK/år\n\n${data.notes.join('\n')}`);
                    } else {
                        alert(data.message);
                    }
                } catch (error) {
                    alert('Kunde inte uppskatta stödtjänster: ' + error.message);
                }
            };

            const selectPreset = (preset) => {
                setConfig({
                    ...config,
                    battery_capacity_kwh: preset.capacity_kwh,
                    battery_power_kw: preset.power_kw,
                    battery_cost_sek: preset.cost_sek
                });
            };

            const selectOperator = (operator) => {
                setConfig({
                    ...config,
                    grid_fee_sek_kwh: operator.grid_fee_sek_kwh,
                    effect_tariff_sek_kw_month: operator.effect_tariff_sek_kw_month
                });
            };

            return (
                <div className="min-h-screen p-8">
                    <div className="max-w-6xl mx-auto">
                        <div className="text-center mb-8">
                            <h1 className="text-4xl font-bold text-white mb-2">
                                ⚡ Batteri ROI Kalkylator
                            </h1>
                            <p className="text-white opacity-90">
                                Beräkna avkastningen på din batteriinvestering med verklig Tibber-data
                            </p>
                        </div>

                        <div className="flex justify-center mb-8">
                            <div className="flex items-center space-x-4">
                                <StepIndicator num={1} active={step === 1} completed={step > 1} label="Ladda upp data" />
                                <div className="w-12 h-1 bg-white opacity-30"></div>
                                <StepIndicator num={2} active={step === 2} completed={step > 2} label="Konfigurera" />
                                <div className="w-12 h-1 bg-white opacity-30"></div>
                                <StepIndicator num={3} active={step === 3} completed={false} label="Resultat" />
                            </div>
                        </div>

                        {step === 1 && (
                            <Step1Upload 
                                file={file}
                                loading={loading}
                                onFileChange={handleFileChange}
                                onUpload={handleUpload}
                            />
                        )}

                        {step === 2 && (
                            <Step2Configure
                                config={config}
                                setConfig={setConfig}
                                loading={loading}
                                progress={progress}
                                batteryPresets={batteryPresets}
                                networkOperators={networkOperators}
                                onSimulate={handleSimulate}
                                onBack={() => setStep(1)}
                                onEstimateStodtjanster={estimateStodtjanster}
                                selectPreset={selectPreset}
                                selectOperator={selectOperator}
                            />
                        )}

                        {step === 3 && results && (
                            <Step3Results
                                results={results}
                                config={config}
                                onBack={() => setStep(2)}
                            />
                        )}
                    </div>
                </div>
            );
        }

        function StepIndicator({ num, active, completed, label }) {
            return (
                <div className="flex flex-col items-center">
                    <div className={`w-12 h-12 rounded-full flex items-center justify-center font-bold
                        ${completed ? 'bg-green-500 text-white' : 
                          active ? 'bg-white text-purple-600' : 
                          'bg-white bg-opacity-30 text-white'}`}>
                        {completed ? '✓' : num}
                    </div>
                    <span className="text-white text-sm mt-2 opacity-90">{label}</span>
                </div>
            );
        }

        function Step1Upload({ file, loading, onFileChange, onUpload }) {
            return (
                <div className="card">
                    <h2 className="text-2xl font-bold mb-4">Steg 1: Ladda upp Tibber-data</h2>
                    <p className="text-gray-600 mb-6">
                        Ladda upp din CSV-fil från Tibber med timvisa elpriser och förbrukning. 
                        Du kan exportera detta från Tibber-appen under "Användning" → "Exportera data".
                    </p>

                    <div className="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center mb-4">
                        <input
                            type="file"
                            accept=".csv,.xlsx"
                            onChange={onFileChange}
                            className="hidden"
                            id="fileInput"
                        />
                        <label htmlFor="fileInput" className="cursor-pointer">
                            <div className="text-4xl mb-4">📁</div>
                            <p className="text-lg font-semibold mb-2">
                                {file ? file.name : 'Klicka för att välja fil'}
                            </p>
                            <p className="text-gray-500">CSV eller XLSX (max 16MB)</p>
                        </label>
                    </div>

                    <button
                        onClick={onUpload}
                        disabled={!file || loading}
                        className="button-primary w-full"
                    >
                        {loading ? 'Laddar upp...' : 'Ladda upp och fortsätt'}
                    </button>

                    <div className="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h3 className="font-semibold text-blue-900 mb-2">💡 Tips:</h3>
                        <ul className="text-blue-800 text-sm space-y-1">
                            <li>• Använd minst 12 månaders data för bäst resultat</li>
                            <li>• Filen bör innehålla: tidsstämpel, förbrukning (kWh), spotpris (SEK/kWh)</li>
                            <li>• Exportera från Tibber-appen eller webbplatsen</li>
                        </ul>
                    </div>
                </div>
            );
        }

        function Step2Configure({ config, setConfig, loading, progress, batteryPresets, networkOperators, 
                                 onSimulate, onBack, onEstimateStodtjanster, selectPreset, selectOperator }) {
            return (
                <div className="space-y-6">
                    <div className="card">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold">Steg 2: Konfigurera din installation</h2>
                            <button onClick={onBack} className="text-purple-600 hover:underline">
                                ← Tillbaka
                            </button>
                        </div>

                        <div className="mb-6">
                            <h3 className="text-lg font-semibold mb-3">Batterisystem</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                {batteryPresets.map((preset, idx) => (
                                    <div
                                        key={idx}
                                        onClick={() => selectPreset(preset)}
                                        className="border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-purple-500 transition"
                                    >
                                        <div className="font-semibold">{preset.name}</div>
                                        <div className="text-sm text-gray-600">
                                            {preset.capacity_kwh} kWh, {preset.power_kw} kW
                                        </div>
                                        <div className="text-sm font-semibold text-purple-600">
                                            {preset.cost_sek.toLocaleString()} SEK
                                        </div>
                                        <div className="text-xs text-gray-500 mt-1">{preset.description}</div>
                                    </div>
                                ))}
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <InputField
                                    label="Kapacitet (kWh)"
                                    type="number"
                                    value={config.battery_capacity_kwh}
                                    onChange={(e) => setConfig({...config, battery_capacity_kwh: parseFloat(e.target.value)})}
                                />
                                <InputField
                                    label="Växelriktare effekt (kW)"
                                    type="number"
                                    value={config.battery_power_kw}
                                    onChange={(e) => setConfig({...config, battery_power_kw: parseFloat(e.target.value)})}
                                    help="Ange din växelriktares max effekt (ex: Solis 12 kW)"
                                />
                                <InputField
                                    label="Kostnad (SEK)"
                                    type="number"
                                    value={config.battery_cost_sek}
                                    onChange={(e) => setConfig({...config, battery_cost_sek: parseFloat(e.target.value)})}
                                />
                            </div>
                        </div>

                        <div className="mb-6">
                            <h3 className="text-lg font-semibold mb-3">Nätbolag</h3>
                            <select
                                className="w-full p-2 border border-gray-300 rounded-lg mb-4"
                                onChange={(e) => {
                                    const op = networkOperators[e.target.value];
                                    if (op) selectOperator(op);
                                }}
                            >
                                <option value="">Välj nätbolag...</option>
                                {networkOperators.map((op, idx) => (
                                    <option key={idx} value={idx}>
                                        {op.name} - {op.region}
                                    </option>
                                ))}
                            </select>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <InputField
                                    label="Nätavgift (SEK/kWh)"
                                    type="number"
                                    step="0.01"
                                    value={config.grid_fee_sek_kwh}
                                    onChange={(e) => setConfig({...config, grid_fee_sek_kwh: parseFloat(e.target.value)})}
                                />
                                <InputField
                                    label="Effekttariff (SEK/kW/månad)"
                                    type="number"
                                    value={config.effect_tariff_sek_kw_month}
                                    onChange={(e) => setConfig({...config, effect_tariff_sek_kw_month: parseFloat(e.target.value)})}
                                />
                            </div>

                            <div className="mb-4">
                                <label className="block text-sm font-medium mb-2">Effekttariff beräkningsmetod</label>
                                <select
                                    className="w-full p-3 border border-gray-600 rounded-lg bg-gray-800 text-white focus:ring-2 focus:ring-blue-500"
                                    value={config.effect_tariff_method}
                                    onChange={(e) => setConfig({...config, effect_tariff_method: e.target.value})}
                                >
                                    <option value="top3_average">Medelvärde av 3 högsta topparna per månad (E.ON)</option>
                                    <option value="single_peak">Enskild högsta topp per månad</option>
                                </select>
                                <p className="text-sm text-gray-400 mt-1">E.ON använder medelvärde av 3 högsta toppar. Andra nätbolag kan använda andra metoder.</p>
                            </div>
                        </div>

                        <div className="mb-6">
                            <h3 className="text-lg font-semibold mb-3">Solceller (valfritt)</h3>
                            <InputField
                                label="Installerad effekt (kWp)"
                                type="number"
                                value={config.solar_capacity_kwp}
                                onChange={(e) => setConfig({...config, solar_capacity_kwp: parseFloat(e.target.value)})}
                                help="Lämna 0 om du inte har solceller"
                            />
                        </div>

                        <div className="mb-6">
                            <h3 className="text-lg font-semibold mb-3">Arbitrage (avancerat)</h3>
                            <p className="text-sm text-gray-600 mb-3">
                                Låt batteriet köpa el när det är billigt och sälja när det är dyrt för att maximera vinsten.
                            </p>
                            
                            <div className="space-y-3">
                                <label className="flex items-center space-x-3">
                                    <input
                                        type="checkbox"
                                        checked={config.enable_arbitrage}
                                        onChange={(e) => setConfig({...config, enable_arbitrage: e.target.checked})}
                                        className="w-4 h-4 text-purple-600 bg-gray-100 border-gray-300 rounded focus:ring-purple-500"
                                    />
                                    <span className="text-sm">
                                        Aktivera arbitrage
                                        <span className="text-xs text-gray-500 block">
                                            Använder Boss Agent med 24h LP-optimering för bästa resultat
                                        </span>
                                    </span>
                                </label>
                            </div>
                        </div>

                        <div className="mb-6">
                            <h3 className="text-lg font-semibold mb-3">Stödtjänster (valfritt)</h3>
                            <p className="text-sm text-gray-600 mb-3">
                                Tjäna extra pengar genom att tillhandahålla frekvensreglering till elnätet
                            </p>
                            
                            <div className="flex space-x-2 mb-3">
                                <button
                                    onClick={() => onEstimateStodtjanster('fcr_n')}
                                    className="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200"
                                >
                                    Uppskatta FCR-N
                                </button>
                                <button
                                    onClick={() => onEstimateStodtjanster('fcr_d')}
                                    className="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200"
                                >
                                    Uppskatta FCR-D
                                </button>
                            </div>

                            <InputField
                                label="Årlig intäkt från stödtjänster (SEK)"
                                type="number"
                                value={config.stodtjanster_revenue_sek_year}
                                onChange={(e) => setConfig({...config, stodtjanster_revenue_sek_year: parseFloat(e.target.value)})}
                            />
                        </div>

                        <div className="mb-6 bg-yellow-900/20 border border-yellow-700 rounded-lg p-4">
                            <h3 className="text-lg font-semibold mb-3 text-yellow-500">🧪 Testperiod (för snabbare debug)</h3>
                            <p className="text-sm text-gray-400 mb-3">Begränsa simuleringen till 2 månader istället för hela året</p>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <InputField
                                    label="Startdatum"
                                    type="text"
                                    placeholder="2024-12-01"
                                    value={config.date_range_start || ''}
                                    onChange={(e) => setConfig({...config, date_range_start: e.target.value || undefined})}
                                    help="Format: YYYY-MM-DD"
                                />
                                <InputField
                                    label="Slutdatum"
                                    type="text"
                                    placeholder="2025-01-31"
                                    value={config.date_range_end || ''}
                                    onChange={(e) => setConfig({...config, date_range_end: e.target.value || undefined})}
                                    help="Format: YYYY-MM-DD"
                                />
                            </div>
                            <p className="text-xs text-gray-500 mt-2">💡 Tips: Lämna tomt för att simulera hela perioden</p>
                        </div>

                        <button
                            onClick={onSimulate}
                            disabled={loading}
                            className="button-primary w-full"
                        >
                            {loading ? (
                                <div className="flex flex-col items-center gap-2">
                                    <span>Beräknar... {progress.percent.toFixed(0)}%</span>
                                    <span className="text-sm">{progress.message}</span>
                                </div>
                            ) : 'Beräkna ROI'}
                        </button>
                    </div>
                </div>
            );
        }

        function Step3Results({ results, config, onBack }) {
            const roi = results.summary.roi;
            const withBattery = results.summary.with_battery;
            const withoutBattery = results.summary.without_battery;

            return (
                <div className="space-y-6">
                    <div className="card">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold">Resultat: Din ROI-analys</h2>
                            <button onClick={onBack} className="text-purple-600 hover:underline">
                                ← Ändra inställningar
                            </button>
                        </div>

                        {/* Key Metrics */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div className="metric">
                                <div className="metric-label">Återbetalningstid</div>
                                <div className="metric-value">
                                    {roi.payback_period_years < 100 ? 
                                        `${roi.payback_period_years.toFixed(1)} år` : 
                                        'Ej lönsamt'}
                                </div>
                            </div>
                            <div className="metric">
                                <div className="metric-label">Årlig besparing</div>
                                <div className="metric-value">
                                    {roi.annual_savings_sek.toLocaleString('sv-SE', {maximumFractionDigits: 0})} SEK
                                </div>
                            </div>
                            <div className="metric">
                                <div className="metric-label">Netto vinst (15 år)</div>
                                <div className="metric-value">
                                    {roi.net_profit_sek.toLocaleString('sv-SE', {maximumFractionDigits: 0})} SEK
                                </div>
                            </div>
                        </div>

                        {/* Insights */}
                        <div className="mb-6">
                            <h3 className="text-lg font-semibold mb-3">Insikter</h3>
                            {results.insights && results.insights.map((insight, idx) => (
                                <div
                                    key={idx}
                                    className={`p-4 rounded-lg mb-3 insight-${insight.type}`}
                                >
                                    <div className="font-semibold">{insight.title}</div>
                                    <div className="text-sm mt-1">{insight.message}</div>
                                </div>
                            ))}
                        </div>

                        {/* Cost Comparison */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div className="border border-gray-200 rounded-lg p-4">
                                <h3 className="font-semibold mb-3">Utan batteri</h3>
                                <div className="space-y-2 text-sm">
                                    <div className="flex justify-between">
                                        <span>Förbrukning:</span>
                                        <span className="font-semibold">
                                            {withoutBattery.total_consumption_kwh.toLocaleString('sv-SE', {maximumFractionDigits: 0})} kWh
                                        </span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span>Total kostnad:</span>
                                        <span className="font-semibold">
                                            {withoutBattery.total_cost_sek.toLocaleString('sv-SE', {maximumFractionDigits: 0})} SEK
                                        </span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span>Genomsnittspris:</span>
                                        <span className="font-semibold">
                                            {withoutBattery.average_price_sek_kwh.toFixed(2)} SEK/kWh
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <div className="border border-green-200 bg-green-50 rounded-lg p-4">
                                <h3 className="font-semibold mb-3 text-green-900">Med batteri</h3>
                                <div className="space-y-2 text-sm">
                                    <div className="flex justify-between">
                                        <span>Netto kostnad:</span>
                                        <span className="font-semibold text-green-900">
                                            {withBattery.net_cost_sek.toLocaleString('sv-SE', {maximumFractionDigits: 0})} SEK
                                        </span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span>Självförbrukning:</span>
                                        <span className="font-semibold text-green-900">
                                            {(withBattery.self_consumption_rate * 100).toFixed(0)}%
                                        </span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span>Exportintäkt:</span>
                                        <span className="font-semibold text-green-900">
                                            {withBattery.export_revenue_sek.toLocaleString('sv-SE', {maximumFractionDigits: 0})} SEK
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Monthly Breakdown */}
                        <div>
                            <h3 className="text-lg font-semibold mb-3">Månadsvis uppdelning</h3>
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm">
                                    <thead className="bg-gray-100">
                                        <tr>
                                            <th className="p-2 text-left">Månad</th>
                                            <th className="p-2 text-right">Förbrukning (kWh)</th>
                                            <th className="p-2 text-right">Solproduktion (kWh)</th>
                                            <th className="p-2 text-right">Självförbrukning (kWh)</th>
                                            <th className="p-2 text-right">Kostnad (SEK)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {results.monthly_data && results.monthly_data.map((month, idx) => (
                                            <tr key={idx} className="border-b border-gray-200">
                                                <td className="p-2">{month.month}</td>
                                                <td className="p-2 text-right">
                                                    {month.consumption_kwh.toFixed(0)}
                                                </td>
                                                <td className="p-2 text-right">
                                                    {month.solar_kwh.toFixed(0)}
                                                </td>
                                                <td className="p-2 text-right">
                                                    {month.self_consumption_kwh.toFixed(0)}
                                                </td>
                                                <td className="p-2 text-right">
                                                    {month.total_cost_with_vat.toFixed(0)}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    {/* ROI Details */}
                    <div className="card">
                        <h3 className="text-lg font-semibold mb-4">ROI-detaljer</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 className="font-semibold mb-2">Investering</h4>
                                <div className="space-y-2 text-sm">
                                    <div className="flex justify-between">
                                        <span>Batterikostnad:</span>
                                        <span>{roi.battery_cost_sek.toLocaleString('sv-SE')} SEK</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span>Livslängd:</span>
                                        <span>{roi.lifetime_years} år</span>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h4 className="font-semibold mb-2">Avkastning</h4>
                                <div className="space-y-2 text-sm">
                                    <div className="flex justify-between">
                                        <span>Total besparing:</span>
                                        <span>{roi.total_lifetime_savings_sek.toLocaleString('sv-SE')} SEK</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span>ROI:</span>
                                        <span className={roi.roi_percentage > 0 ? 'text-green-600 font-semibold' : 'text-red-600'}>
                                            {roi.roi_percentage.toFixed(1)}%
                                        </span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span>NPV (3% diskontering):</span>
                                        <span className={roi.npv_sek > 0 ? 'text-green-600 font-semibold' : 'text-red-600'}>
                                            {roi.npv_sek.toLocaleString('sv-SE', {maximumFractionDigits: 0})} SEK
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function InputField({ label, type, value, onChange, step, help }) {
            return (
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                        {label}
                    </label>
                    <input
                        type={type}
                        value={value}
                        onChange={onChange}
                        step={step}
                        className="w-full p-2 border border-gray-300 rounded-lg"
                    />
                    {help && <p className="text-xs text-gray-500 mt-1">{help}</p>}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
